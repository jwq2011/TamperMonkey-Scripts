
### **AI 总结：Tampermonkey 表格提取与多格式导出工具**

#### **脚本名称**
**"表格提取与多格式导出工具（增强版）"**

---

#### **核心功能**
1. **智能识别网页中的表格**：
   - 自动检测页面中符合条件的表格（至少 2 行 2 列）。
   - 每个符合条件的表格会生成一个“提取表格”按钮，按钮固定在表格附近。

2. **一键提取表格数据**：
   - 鼠标悬停到表格上时显示“提取表格”按钮。
   - 提供快捷键支持（`Alt + E`），当鼠标悬停在表格上时按下快捷键即可提取数据。
   - 按钮延迟隐藏机制：当鼠标移开表格或按钮时，按钮不会立即消失，而是延迟 1 秒隐藏，避免用户操作中断。

3. **多格式导出支持**：
   - 支持以下格式导出：
     - **JSON**：结构化数据存储。
     - **CSV**：适合 Excel 和数据分析工具。
     - **Excel**（`.xlsx`）：直接生成电子表格文件。
     - **Markdown**：易于阅读和编辑的内容格式。
     - **SQL**：生成 INSERT 语句用于数据库导入。
     - **HTML**：带样式保存表格内容。
     - **PDF（带格式/纯文本）**：支持图表截图和纯文本内容两种方式导出。
   - 文件名优先使用表格上方的小标题（如 `<h1>`、`<h2>` 等），如果没有小标题，则默认文件名为 `table.xlsx`。

4. **表格工具增强功能**：
   - **表格样式保留**：
     - 在导出 HTML 或 PDF（带格式）时，保留原始表格的样式（如边框、字体、颜色等）。
   - **批量提取与导出**：
     - 全局按钮可提取页面中所有符合条件的表格，并支持：
       - 合并导出为单一 Excel 文件。
       - （暂未实现）逐个导出为多个文件。
   - **复制到剪贴板**：
     - 支持原格式（Tab 分隔）或 Markdown 格式的数据复制。
   - **数据预览窗口**：
     - 在导出前允许用户通过浮动窗口查看提取的表格数据。

5. **用户体验优化**：
   - 导出成功或失败均有明确的状态提示（成功提示绿色文字，失败提示红色文字）。
   - 使用 Microsoft YaHei 字体解决中文乱码问题，确保 PDF 导出的兼容性。

---

#### **注意事项**
1. **快捷键使用**：
   - 快捷键 `Alt + E` 只有在鼠标悬停在表格上时才会触发。如果未悬停在任何表格上，会弹出提示：“请将鼠标悬停在一个表格上！”

2. **Excel 导出**：
   - 确保文件名以 `.xlsx` 结尾，否则可能会导致 `xlsx` 库无法识别文件类型。
   - 默认文件名为 `table.xlsx`，如果表格上方有小标题，则使用小标题命名。

3. **错误处理**：
   - 所有的导出操作都包含错误捕获机制，并提供详细的错误提示（包括控制台日志和弹窗信息）。
   - 如果某个格式导出失败，请检查浏览器控制台中的错误信息。

4. **按钮显示逻辑**：
   - 按钮仅在鼠标悬停到表格上时显示。
   - 延迟隐藏机制确保按钮不会因为鼠标短暂移开而立即消失。

5. **依赖管理**：
   - 脚本需要安装 Tampermonkey 扩展。
   - 如果需要离线开发或部署，可以手动下载并引入所需的库文件（如 `xlsx` 和 `FileSaver.js`）。

---

#### **完整功能需求回顾**
- **自动检测表格**：
  - 检测页面中的所有表格，并验证其是否包含至少 2 行 2 列的数据。
- **按钮显示**：
  - 每个表格对应一个固定的“提取表格”按钮。
  - 按钮只在鼠标悬停到表格范围内时显示，并且有延迟隐藏机制。
- **数据提取与导出**：
  - 提取表格中的所有数据，并支持多种格式导出。
  - 文件名优先使用表格上方的小标题，若无小标题则使用默认文件名。
- **快捷键支持**：
  - 提供快捷键（`Alt + E`），方便快速提取表格数据。
- **用户体验优化**：
  - 按钮延迟隐藏机制，避免因鼠标操作不当导致按钮过早消失。
  - 错误提示友好清晰，便于调试和排查问题。

---

#### **新增功能点（1.5 版本重点）**
1. **PDF 导出修复**：
   - 支持带格式和纯文本两种 PDF 导出模式。
   - 使用 Microsoft YaHei 字体解决了中文乱码问题。
   - PDF 带格式导出使用 `html2canvas` 渲染为图片后嵌入 PDF，确保样式完整性。

2. **数据预览窗口**：
   - 增加了数据预览功能，点击“数据预览”按钮后会在页面中央弹出浮动窗口展示提取的表格数据。
   - 浮动窗口支持滚动查看，最大高度占屏幕的 80%。

3. **复制到剪贴板**：
   - 提供两种格式的数据复制选项：原格式（Tab 分隔）和 Markdown 格式。
   - 成功复制后会弹出提示“内容已复制到剪贴板！”。

4. **状态提示**：
   - 每次导出操作完成后，都会显示成功或失败的状态提示。
   - 提示信息位于导出菜单底部，绿色表示成功，红色表示失败。

---

#### **提示词**
如果您下次需要基于此脚本提问或讨论，请使用以下关键词或描述：

1. **“Tampermonkey 表格提取工具”**：
   - 描述脚本的核心用途：提取网页中的表格数据。

2. **“多格式导出支持”**：
   - 提及脚本支持的导出格式（JSON、CSV、Excel 等）。

3. **“PDF 导出修复”**：
   - 如果遇到 PDF 导出问题（如乱码或样式不完整），可以提及此版本修复的历史。

4. **“数据预览窗口优化”**：
   - 如果需要调整数据预览窗口的功能或样式。

5. **“复制到剪贴板功能”**：
   - 如果需要修改或扩展复制功能（如增加更多格式选项）。

6. **“批量提取与导出”**：
   - 如果需要对全局按钮的批量导出功能进行改进（如分批导出或合并导出）。

7. **“延迟隐藏机制”**：
   - 如果需要调整悬浮按钮的显示逻辑（如延迟时间或位置）。

8. **“状态提示增强”**：
   - 如果需要进一步优化状态提示（如增加进度条或更直观的 UI 交互）。

9. **“字体兼容性”**：
   - 如果需要调整支持 PDF 中文或其他语言的字体配置。

10. **“错误处理与调试”**：
    - 如果遇到某些操作失败，请求提供更友好的错误提示或调试方法。

---

#### **未来可能的扩展**
1. **动态加载外部依赖**：
   - 当前脚本直接通过 `@require` 引入外部库，但如果是离线环境运行，可能需要动态加载这些依赖（如从 CDN 加载）。

2. **更多导出格式支持**：
   - 添加新的导出格式，例如 YAML、LaTeX 或 XML Schema。

3. **复杂表格解析优化**：
   - 对于跨行（`rowspan`）或跨列（`colspan`）的合并单元格，增加拆分选项或保留原始格式。

4. **云端同步功能**：
   - 将导出的文件自动上传至云存储服务（如 Google Drive 或 Dropbox）。

5. **多语言界面**：
   - 增加国际化支持，用户可以选择语言切换界面文字。

6. **高级筛选与排序功能**：
   - 在导出前允许用户对表格数据进行筛选、排序或删除冗余列。

7. **历史记录与近期操作回顾**：
   - 保存用户的导出历史记录（如最近导出的文件名、格式和时间），便于重复操作。

---

### **总结**
以上总结涵盖了当前脚本的所有功能点、使用注意事项以及未来扩展方向。后续可以根据实际需求逐步实现这些功能。
